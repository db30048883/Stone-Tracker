<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0f14" />
  <title>Stone Tracker Log</title>

  <style>
    :root{
      --bg:#0b0f14; --card:#121a24; --border:#243244; --text:#f5f7fb; --muted:#b9c2cf;
      --accent:#7dd3fc; --danger:#fb7185; --ok:#86efac; --shadow: 0 10px 30px rgba(0,0,0,.45);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text);padding:16px}
    .wrap{max-width:980px;margin:auto;display:flex;flex-direction:column;gap:14px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
    h1{margin:0 0 6px;font-size:20px}
    .sub{color:var(--muted);font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input, textarea{
      width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);
      background:rgba(0,0,0,.25);color:var(--text);font-size:16px
    }
    textarea{min-height:70px;resize:vertical}
    label{display:block;margin:12px 0 6px;color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.08em}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}
    button{
      border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text);
      padding:10px 12px;border-radius:999px;font-weight:800;cursor:pointer
    }
    button.primary{border-color:rgba(125,211,252,.5)}
    button.good{border-color:rgba(134,239,172,.5)}
    button.bad{border-color:rgba(251,113,133,.5)}
    .status{padding:10px;border-radius:12px;border-left:4px solid var(--accent);background:rgba(125,211,252,.08);font-size:14px}
    .status.ok{border-left-color:var(--ok);background:rgba(134,239,172,.08)}
    .status.err{border-left-color:var(--danger);background:rgba(251,113,133,.08)}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th{color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.08em;text-align:left;padding:0 8px}
    td{background:rgba(0,0,0,.2);border:1px solid var(--border);padding:10px 8px;vertical-align:middle}
    tr td:first-child{border-radius:12px 0 0 12px}
    tr td:last-child{border-radius:0 12px 12px 0}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .tiny{color:var(--muted);font-size:12px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    a{color:var(--accent);text-decoration:none;font-weight:800}
    .qrbox{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start}
    .qrbox canvas{border-radius:12px;border:1px solid var(--border);background:#fff}
    .pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px}
  </style>

  <!-- QR library: local file preferred (offline-safe). Put qrcode.min.js in repo root OR change src. -->
  <script src="./qrcode.min.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>Stone Tracker Log</h1>
      <div class="sub">Add/update stones, generate QR links, and copy URLs for NFC. Public scan page is <span class="mono">/?id=ST-###</span>.</div>
      <div class="row" style="margin-top:10px">
        <span class="pill">Viewer: <a href="./">index</a></span>
        <span class="pill">This log: <a href="./tracker.html">tracker</a></span>
      </div>
    </div>

    <div class="card">
      <div class="grid">
        <div>
          <label>Stone ID</label>
          <input id="id" placeholder="ST-004" autocapitalize="characters" />
        </div>
        <div>
          <label>Weight (lbs)</label>
          <input id="weight" placeholder="4820" inputmode="numeric" />
        </div>
        <div>
          <label>Date weighed</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label>Location</label>
          <input id="location" placeholder="Scale 1 / Stockpile A / Row 3" />
        </div>
      </div>

      <label>Notes (optional)</label>
      <textarea id="notes" placeholder="Shape notes, spalls, destination, etc."></textarea>

      <label>Photo URLs (optional, one per line)</label>
      <textarea id="photos" placeholder="https://&lt;username&gt;.github.io/stone-tracker/photos/ST-004-1.jpg"></textarea>

      <div class="row" style="margin-top:12px">
        <button class="primary" id="btnMake">Make JSON Block</button>
        <button class="good" id="btnCopyJson">Copy JSON</button>
        <button id="btnOpenEdit">Open stones.json (edit)</button>
        <button class="bad" id="btnClear">Clear</button>
      </div>

      <div id="status" class="status" style="margin-top:12px">Ready.</div>

      <div style="margin-top:12px">
        <div class="tiny"><b>Paste this JSON</b> into <span class="mono">stones.json</span> inside the <span class="mono">"stones":[...]</span> list, then commit.</div>
        <pre id="jsonOut" class="mono" style="white-space:pre-wrap;word-break:break-word;background:rgba(0,0,0,.2);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:10px">—</pre>
      </div>

      <div style="margin-top:12px">
        <div class="tiny"><b>QR/NFC URL</b> (encode this):</div>
        <pre id="urlOut" class="mono" style="white-space:pre-wrap;word-break:break-word;background:rgba(0,0,0,.2);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:10px">—</pre>
        <div class="row" style="margin-top:10px">
          <button class="good" id="btnCopyUrl">Copy URL</button>
          <button id="btnOpenStone">Open Stone Page</button>
        </div>
      </div>

      <div style="margin-top:14px">
        <div class="tiny"><b>QR Preview</b> (download/print-ready):</div>
        <div class="qrbox" style="margin-top:10px">
          <canvas id="qrCanvas" width="220" height="220"></canvas>
          <div class="actions">
            <button id="btnDownload">Download QR PNG</button>
            <button id="btnPrint">Print QR</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="sub"><b>Existing Stones</b></div>
          <div class="tiny">Search by ID/location/notes. Click “QR” to generate QR for that stone.</div>
        </div>
        <div style="min-width:260px">
          <input id="search" placeholder="Search ST-001, Scale 1, Stockpile…" />
        </div>
      </div>

      <div style="overflow:auto;margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Weight</th>
              <th>Date</th>
              <th>Location</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="tiny" id="count"></div>
    </div>
  </div>

<script>
  // === EDIT THESE TWO LINES ===
  const BASE_URL = "https://<username>.github.io/stone-tracker/"; // must end with /
  const EDIT_STONES_URL = "https://github.com/<username>/stone-tracker/edit/main/stones.json";

  // Defaults
  document.getElementById("date").valueAsDate = new Date();

  const $ = (id) => document.getElementById(id);
  let STONES = [];

  function status(msg, kind=""){
    const el = $("status");
    el.className = "status" + (kind ? " " + kind : "");
    el.textContent = msg;
  }

  function normId(v){ return String(v||"").trim().toUpperCase(); }
  function safe(v){ return String(v ?? "").trim(); }
  function parsePhotos(text){
    return safe(text).split("\n").map(x => x.trim()).filter(Boolean);
  }

  function buildRecord(){
    const id = normId($("id").value);
    const w = Number(safe($("weight").value));
    const date = $("date").value;
    const loc = safe($("location").value);
    const notes = safe($("notes").value);
    const photos = parsePhotos($("photos").value);

    if(!id) throw new Error("Stone ID required.");
    if(!Number.isFinite(w) || w <= 0) throw new Error("Weight must be a positive number.");
    if(!date) throw new Error("Date required.");
    if(!loc) throw new Error("Location required.");

    return {
      id,
      weight_lbs: w,
      date_weighed: date,
      location: loc,
      notes: notes || "",
      photos,
      updated_at: new Date().toISOString()
    };
  }

  function stoneUrl(id){
    return BASE_URL + "?id=" + encodeURIComponent(normId(id));
  }

  function renderQR(url){
    const canvas = $("qrCanvas");
    // qrcode.min.js exposes QRCode (library dependent). We'll support a common API below:
    if (window.QRCode && QRCode.toCanvas) {
      QRCode.toCanvas(canvas, url, { width: 220, margin: 1 }, (err) => {
        if (err) console.error(err);
      });
    } else if (window.qrcode && qrcode.toCanvas) {
      qrcode.toCanvas(canvas, url, { width: 220, margin: 1 }).catch(console.error);
    } else {
      // Fallback: show message
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = "#fff";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = "#000";
      ctx.font = "14px system-ui";
      ctx.fillText("QR lib missing", 40, 110);
    }
  }

  function setOutputs(rec){
    const url = stoneUrl(rec.id);
    $("urlOut").textContent = url;
    $("jsonOut").textContent = JSON.stringify(rec, null, 2);
    renderQR(url);
  }

  async function copyText(txt){
    try{
      await navigator.clipboard.writeText(txt);
      return true;
    } catch {
      return false;
    }
  }

  $("btnMake").addEventListener("click", () => {
    try{
      const rec = buildRecord();
      setOutputs(rec);
      status("Generated. Copy JSON → paste into stones.json → commit.", "ok");
    } catch(e){
      status(e.message || "Missing/invalid fields.", "err");
    }
  });

  $("btnCopyJson").addEventListener("click", async () => {
    const txt = $("jsonOut").textContent;
    if(!txt || txt === "—") return status("Generate JSON first.", "err");
    const ok = await copyText(txt);
    status(ok ? "Copied JSON." : "Clipboard blocked. Long-press to copy from the JSON box.", ok ? "ok" : "err");
  });

  $("btnCopyUrl").addEventListener("click", async () => {
    const txt = $("urlOut").textContent;
    if(!txt || txt === "—") return status("Generate URL first.", "err");
    const ok = await copyText(txt);
    status(ok ? "Copied URL (use for NFC + QR)." : "Clipboard blocked. Long-press to copy the URL box.", ok ? "ok" : "err");
  });

  $("btnOpenStone").addEventListener("click", () => {
    const url = $("urlOut").textContent;
    if(!url || url === "—") return status("Generate a URL first.", "err");
    window.open(url, "_blank", "noopener");
  });

  $("btnOpenEdit").addEventListener("click", () => window.open(EDIT_STONES_URL, "_blank", "noopener"));

  $("btnDownload").addEventListener("click", () => {
    const canvas = $("qrCanvas");
    const url = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    const id = normId($("id").value) || "stone";
    a.href = url;
    a.download = `${id}-QR.png`;
    a.click();
  });

  $("btnPrint").addEventListener("click", () => {
    const canvas = $("qrCanvas");
    const dataUrl = canvas.toDataURL("image/png");
    const id = normId($("id").value) || "STONE";
    const w = window.open("", "_blank");
    w.document.write(`
      <html><head><title>Print QR</title>
      <style>
        body{font-family:system-ui; text-align:center; padding:24px}
        img{width:320px;height:320px}
        .id{font-size:22px;font-weight:900;margin-top:12px}
        .url{font-size:12px;margin-top:8px;word-break:break-all}
      </style></head><body>
      <img src="${dataUrl}" />
      <div class="id">${id}</div>
      <div class="url">${$("urlOut").textContent}</div>
      <script>window.onload=()=>{window.print();}</script>
      </body></html>
    `);
    w.document.close();
  });

  $("btnClear").addEventListener("click", () => {
    ["id","weight","location","notes","photos"].forEach(x => $(x).value = "");
    $("date").valueAsDate = new Date();
    $("jsonOut").textContent = "—";
    $("urlOut").textContent = "—";
    renderQR(" ");
    status("Cleared.", "");
  });

  async function loadStones(){
    const res = await fetch("./stones.json", { cache: "no-store" });
    const data = await res.json();
    const list = Array.isArray(data) ? data : (data.stones || []);
    STONES = list;
    renderTable();
  }

  function renderTable(){
    const q = safe($("search").value).toLowerCase();
    const tbody = $("tbody");
    tbody.innerHTML = "";

    const filtered = STONES.filter(s => {
      const blob = [
        s.id, s.weight_lbs, s.date_weighed, s.location, s.notes
      ].join(" ").toLowerCase();
      return blob.includes(q);
    });

    for(const s of filtered){
      const tr = document.createElement("tr");
      const url = stoneUrl(s.id);

      tr.innerHTML = `
        <td class="mono">${normId(s.id)}</td>
        <td>${Number(s.weight_lbs||0).toLocaleString()} lbs</td>
        <td class="mono">${safe(s.date_weighed) || "—"}</td>
        <td>${safe(s.location) || "—"}</td>
        <td>
          <div class="actions">
            <button data-act="qr" data-id="${normId(s.id)}">QR</button>
            <button data-act="copy" data-url="${url}">Copy URL</button>
            <button data-act="open" data-url="${url}">Open</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    }

    $("count").textContent = `${filtered.length} stone(s) shown.`;
  }

  $("search").addEventListener("input", renderTable);

  $("tbody").addEventListener("click", async (e) => {
    const btn = e.target.closest("button");
    if(!btn) return;

    const act = btn.dataset.act;
    if(act === "qr"){
      const id = btn.dataset.id;
      // prefill form for convenience
      $("id").value = id;
      $("urlOut").textContent = stoneUrl(id);
      $("jsonOut").textContent = "—";
      renderQR(stoneUrl(id));
      status(`QR generated for ${id}.`, "ok");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
    if(act === "copy"){
      const ok = await copyText(btn.dataset.url);
      status(ok ? "Copied URL." : "Clipboard blocked; long-press the URL instead.", ok ? "ok" : "err");
    }
    if(act === "open"){
      window.open(btn.dataset.url, "_blank", "noopener");
    }
  });

  // Init
  renderQR(" ");
  loadStones().catch(err => {
    console.error(err);
    status("Failed to load stones.json. Check it exists and is valid JSON.", "err");
  });
</script>
</body>
</html>
