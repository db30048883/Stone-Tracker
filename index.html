<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Stone Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0B3D91" />
  <link rel="manifest" href="manifest.webmanifest" />

  <style>
    :root {
      --bg: #ffffff;
      --fg: #0b0b0b;
      --muted: #5a5a5a;
      --accent: #0B3D91;  /* deep blue: high contrast outdoors */
      --warn: #b00020;    /* red for not-found */
      --card: #f5f7fb;
      --shadow: rgba(0,0,0,0.08);
      --font-size-base: 18px; /* larger base for outdoor readability */
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0;
      background: var(--bg); color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: var(--font-size-base);
      line-height: 1.35;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    header {
      position: sticky; top: 0; z-index: 10;
      background: var(--bg);
      border-bottom: 2px solid var(--accent);
      padding: 12px 16px;
      display: flex; justify-content: space-between; align-items: center;
    }
    header h1 {
      font-size: 1.25rem; margin: 0; font-weight: 700; letter-spacing: 0.25px;
    }
    .status {
      font-size: 0.9rem; padding: 4px 10px; border-radius: 999px;
      background: #e6f0ff; color: var(--accent); border: 1px solid #c9dcff;
    }
    .status.offline { background: #ffecec; color: #9a0012; border-color: #ffc1c7; }

    main { padding: 16px; max-width: 720px; margin: 0 auto; }

    .card {
      background: var(--card);
      border: 1px solid #e1e6f0;
      border-radius: 10px; padding: 16px;
      box-shadow: 0 2px 8px var(--shadow);
    }
    .stone-id {
      font-weight: 800; font-size: 1.4rem; letter-spacing: 0.5px;
      color: var(--accent); margin-bottom: 8px;
      word-break: break-word;
    }
    .rows { display: grid; grid-template-columns: 1fr; gap: 8px; }
    .row { display: flex; justify-content: space-between; gap: 12px; }
    .label { color: var(--muted); font-weight: 600; }
    .value { font-weight: 700; }

    .notes {
      margin-top: 12px; padding: 12px;
      background: #fff; border: 1px solid #e8edf6; border-radius: 8px;
    }
    .notes .label { display: block; margin-bottom: 6px; }

    .photos {
      margin-top: 12px; display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 8px;
    }
    .photos img {
      width: 100%; height: 120px; object-fit: cover;
      border-radius: 6px; border: 1px solid #e1e6f0; background: #fff;
    }

    .help, .not-found {
      border: 2px solid #f0f0f0; background: #fff; padding: 16px; border-radius: 10px;
    }
    .not-found { border-color: #ffd1d6; background: #fff5f6; color: var(--warn); }

    .foot {
      margin-top: 14px; color: var(--muted); font-size: 0.9rem;
      display: flex; justify-content: space-between; gap: 12px; align-items: center;
    }
    .btn {
      display: inline-block; text-decoration: none; color: #fff;
      background: var(--accent); padding: 10px 14px; border-radius: 8px;
      font-weight: 700; border: 2px solid var(--accent);
    }
    .btn.secondary {
      background: #fff; color: var(--accent); border-color: var(--accent);
    }

    @media (min-width: 480px) {
      .rows { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Stone Tracker</h1>
    <div id="netStatus" class="status">Online</div>
  </header>

  <main>
    <div id="container"></div>
  </main>

  <script>
    // OPTIONAL: If you want to use a published Google Sheet CSV, paste the CSV URL below:
    // Example: const CSV_URL = 'https://docs.google.com/spreadsheets/d/XXX/pub?output=csv';
    // Leave as null to use stones.json in this repo.
    const CSV_URL = null;

    // Allow override via querystring: ?csv=https://.../pub?output=csv
    const qs = new URLSearchParams(location.search);
    const idParam = (qs.get('id') || '').trim();
    const stoneId = idParam.toUpperCase();
    const csvParam = qs.get('csv');
    const CSV_OVERRIDE = csvParam ? decodeURIComponent(csvParam) : null;

    // Network status indicator
    const netStatus = document.getElementById('netStatus');
    function updateNetStatus() {
      const online = navigator.onLine;
      netStatus.textContent = online ? 'Online' : 'Offline';
      netStatus.classList.toggle('offline', !online);
    }
    window.addEventListener('online', updateNetStatus);
    window.addEventListener('offline', updateNetStatus);
    updateNetStatus();

    // Register service worker (optional but recommended)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(console.debug);
    }

    // CSV parser that handles quoted fields and commas inside quotes
    function parseCSV(text) {
      const rows = [];
      let i = 0, field = '', row = [], inQuotes = false;
      while (i < text.length) {
        const c = text[i];
        if (inQuotes) {
          if (c === '"') {
            if (text[i + 1] === '"') { field += '"'; i++; } // escaped quote
            else { inQuotes = false; }
          } else {
            field += c;
          }
        } else {
          if (c === '"') inQuotes = true;
          else if (c === ',') { row.push(field); field = ''; }
          else if (c === '\n' || c === '\r') {
            if (c === '\r' && text[i + 1] === '\n') i++;
            row.push(field); field = '';
            if (row.length && row.some(cell => cell !== '')) rows.push(row);
            row = [];
          } else field += c;
        }
        i++;
      }
      if (field.length || row.length) { row.push(field); rows.push(row); }
      return rows;
    }

    // Convert CSV rows to an object keyed by id
    function csvToMap(text) {
      const rows = parseCSV(text);
      if (!rows.length) return {};
      const headers = rows[0].map(h => h.trim().toLowerCase());
      const map = {};
      for (let r = 1; r < rows.length; r++) {
        const obj = {};
        headers.forEach((h, idx) => obj[h] = (rows[r][idx] || '').trim());
        const id = (obj.id || '').toUpperCase();
        if (!id) continue;
        const photos = (obj.photos || '')
          .split(/[;|,]/).map(s => s.trim()).filter(Boolean);
        const weight = obj.weight_lbs ? Number(obj.weight_lbs.replace(/[, ]/g, '')) : null;
        map[id] = {
          id,
          weight_lbs: Number.isFinite(weight) ? weight : null,
          date_weighed: obj.date_weighed || '',
          location: obj.location || '',
          notes: obj.notes || '',
          photos
        };
      }
      return map;
    }

    async function loadData() {
      try {
        if (CSV_OVERRIDE || CSV_URL) {
          const url = CSV_OVERRIDE || CSV_URL;
          const res = await fetch(url, { cache: 'no-store' });
          if (!res.ok) throw new Error('CSV fetch failed');
          const text = await res.text();
          return csvToMap(text);
        }
      } catch (e) {
        console.warn('CSV load failed; falling back to stones.json', e);
      }
      // Default: stones.json in repo
      const res = await fetch('./stones.json', { cache: 'no-store' });
      if (!res.ok) throw new Error('stones.json not found');
      return await res.json();
    }

    function fmtNumber(n) {
      try { return new Intl.NumberFormat().format(n); }
      catch { return String(n); }
    }
    function fmtDate(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      if (isNaN(d)) return iso;
      const opts = { year: 'numeric', month: 'short', day: '2-digit' };
      return d.toLocaleDateString(undefined, opts);
    }

    function renderHelp() {
      return `
        <div class="help card">
          <div class="stone-id">No stone selected</div>
          <p>Append <code>?id=ST-001</code> to the URL or scan a tag that encodes the full URL.</p>
          <p>Example: <strong>${location.origin}${location.pathname}?id=ST-001</strong></p>
        </div>
      `;
    }

    function renderNotFound(id) {
      return `
        <div class="not-found card">
          <div class="stone-id">ID: ${id}</div>
          <p><strong>Not found.</strong> This ID isn’t in <code>stones.json</code>.</p>
          <p>Confirm the ID or add it to your data source and refresh.</p>
        </div>
      `;
    }

    function renderStone(rec) {
      const photos = (rec.photos || []).map(src => `
        <a href="${src}" target="_blank" rel="noopener">
          <img src="${src}" alt="${rec.id} photo" loading="lazy" />
        </a>
      `).join('');
      return `
        <div class="card">
          <div class="stone-id">${rec.id}</div>
          <div class="rows">
            <div class="row"><span class="label">Weight</span><span class="value">${rec.weight_lbs ? fmtNumber(rec.weight_lbs) + ' lbs' : '—'}</span></div>
            <div class="row"><span class="label">Date weighed</span><span class="value">${rec.date_weighed ? fmtDate(rec.date_weighed) : '—'}</span></div>
            <div class="row"><span class="label">Location</span><span class="value">${rec.location || '—'}</span></div>
          </div>
          <div class="notes">
            <span class="label">Notes</span>
            <div>${(rec.notes || '—').replace(/\n/g, '<br>')}</div>
          </div>
          ${photos ? `<div class="photos">${photos}</div>` : ''}
          <div class="foot">
            <span>Source: ${CSV_OVERRIDE ? 'CSV (override)' : (CSV_URL ? 'CSV' : 'stones.json')}</span>
            <a class="btn secondary" href="${location.origin}${location.pathname}">New Scan</a>
          </div>
        </div>
      `;
    }

    async function init() {
      const container = document.getElementById('container');
      if (!stoneId) {
        container.innerHTML = renderHelp();
        return;
      }
      try {
        const map = await loadData();
        const rec = map[stoneId];
        container.innerHTML = rec ? renderStone(rec) : renderNotFound(stoneId);
      } catch (e) {
        console.error(e);
        container.innerHTML = `
          <div class="not-found card">
            <div class="stone-id">${stoneId}</div>
            <p>Could not load data. Check network or repository files.</p>
          </div>
        `;
      }
    }
    init();
  </script>
</body>
</html>
